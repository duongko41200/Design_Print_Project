<template>
	<div class="flex">
		<div class="sidebar__homePage">
			<SideBar></SideBar>
		</div>

		<div class="swap w-full navbar-homePage max-h-full">
			<div
				class="fixed bottom-0 md:w-[92%] 2xl:w-[94%] h-[56px] sm:top-0 z-50 flex flex-row items-center justify-between backdrop-blur bg-opacity-80 border-t sm:border-t-0 sm:border-b border-opacity-50 text-sm select-none text-slate-50 bg-zinc-900 border-t-zinc-700 sm:border-b-zinc-700"
			>
				<div
					class="hidden sm:flex items-center cursor-pointer px-4 pl-6 left-0 h-full w-32 text_family"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						xmlns:xlink="http://www.w3.org/1999/xlink"
						width="280"
						zoomAndPan="magnify"
						viewBox="0 0 168 48"
						height="94"
						preserveAspectRatio="xMidYMid meet"
						version="1.0"
					>
						<defs><g /></defs>
						<g fill="#ffffff" fill-opacity="1">
							<g transform="translate(23.406885, 34.848904)">
								<g>
									<path
										d="M 1.488281 -0.269531 L 1.488281 0 L 14.671875 0 L 14.671875 -0.269531 C 12.5 -0.269531 11.160156 -1.457031 11.160156 -3.421875 L 11.160156 -12.054688 L 21.339844 -12.054688 L 21.339844 -3.421875 C 21.339844 -1.457031 20 -0.269531 17.828125 -0.269531 L 17.828125 0 L 31.011719 0 L 31.011719 -0.269531 C 28.839844 -0.269531 27.5 -1.457031 27.5 -3.421875 L 27.5 -22.234375 C 27.5 -24.195312 28.839844 -25.386719 31.011719 -25.386719 L 31.011719 -25.65625 L 17.828125 -25.65625 L 17.828125 -25.386719 C 20 -25.386719 21.339844 -24.195312 21.339844 -22.234375 L 21.339844 -12.320312 L 11.160156 -12.320312 L 11.160156 -22.234375 C 11.160156 -24.195312 12.5 -25.386719 14.671875 -25.386719 L 14.671875 -25.65625 L 1.488281 -25.65625 L 1.488281 -25.386719 C 3.660156 -25.386719 5 -24.195312 5 -22.234375 L 5 -3.421875 C 5 -1.457031 3.660156 -0.269531 1.488281 -0.269531 Z M 1.488281 -0.269531 "
									/>
								</g>
							</g>
						</g>
						<g fill="#ffffff" fill-opacity="1">
							<g transform="translate(55.899398, 34.848904)">
								<g>
									<path
										d="M 15.296875 0.207031 C 20.65625 0.207031 25.148438 -2.589844 25.148438 -8.125 L 25.148438 -22.382812 C 25.148438 -24.257812 26.429688 -25.386719 28.511719 -25.386719 L 28.511719 -25.65625 L 21.488281 -25.65625 L 21.488281 -25.386719 C 23.632812 -25.386719 24.882812 -24.257812 24.882812 -22.382812 L 24.882812 -8.125 C 24.882812 -2.113281 19.34375 -0.148438 16.457031 -0.148438 C 11.785156 -0.148438 10.953125 -6.371094 10.953125 -10.59375 L 10.953125 -22.441406 C 10.953125 -24.195312 12.144531 -25.386719 14.316406 -25.386719 L 14.316406 -25.65625 L 1.488281 -25.65625 L 1.488281 -25.386719 C 3.632812 -25.386719 4.882812 -24.195312 4.882812 -22.234375 L 4.882812 -8.332031 C 4.882812 -3.453125 10.328125 0.207031 15.296875 0.207031 Z M 15.296875 0.207031 "
									/>
								</g>
							</g>
						</g>
						<g fill="#ffffff" fill-opacity="1">
							<g transform="translate(85.892488, 34.848904)">
								<g>
									<path
										d="M 14.496094 0 C 16.042969 0 17.5 -0.269531 18.898438 -0.773438 C 21.546875 -1.546875 24.40625 -1.367188 24.496094 -0.269531 L 24.761719 -0.269531 L 24.761719 -8.273438 C 24.820312 -10.148438 26.101562 -11.28125 28.15625 -11.28125 L 28.15625 -11.546875 L 15.328125 -11.546875 L 15.328125 -11.28125 C 17.261719 -11.28125 18.660156 -10.207031 18.691406 -8.246094 L 18.691406 -1.25 C 17.589844 -0.773438 15.683594 -0.355469 14.496094 -0.355469 C 12.648438 -0.355469 7.558594 -1.578125 7.53125 -13.035156 C 7.558594 -24.496094 12.648438 -25.714844 14.496094 -25.714844 C 15.058594 -25.714844 16.371094 -25.597656 17.917969 -25.121094 C 21.160156 -24.019531 22.917969 -21.933594 23.007812 -18.78125 L 23.273438 -18.78125 L 23.273438 -25.804688 L 23.007812 -25.804688 C 22.917969 -24.671875 21.695312 -24.464844 18.898438 -25.296875 C 17.5 -25.804688 16.042969 -26.070312 14.496094 -26.070312 C 11.070312 -26.070312 7.855469 -24.734375 5.386719 -22.351562 C 3.007812 -19.941406 1.667969 -17.023438 1.488281 -13.808594 L 1.488281 -12.320312 C 1.875 -5.417969 7.621094 0 14.496094 0 Z M 14.496094 0 "
									/>
								</g>
							</g>
						</g>
						<g fill="#ffffff" fill-opacity="1">
							<g transform="translate(115.52851, 34.848904)">
								<g>
									<path
										d="M 14.523438 0 C 21.726562 0 27.558594 -5.832031 27.558594 -13.035156 C 27.558594 -20.207031 21.695312 -26.070312 14.523438 -26.070312 C 7.351562 -26.070312 1.488281 -20.207031 1.488281 -13.035156 C 1.488281 -5.953125 7.261719 0 14.523438 0 Z M 14.523438 -0.355469 C 12.679688 -0.355469 7.558594 -1.308594 7.558594 -13.035156 C 7.589844 -24.496094 12.679688 -25.714844 14.523438 -25.714844 C 16.398438 -25.714844 21.488281 -24.496094 21.488281 -13.035156 C 21.488281 -1.308594 16.398438 -0.355469 14.523438 -0.355469 Z M 14.523438 -0.355469 "
									/>
								</g>
							</g>
						</g>
					</svg>
				</div>
				<div
					class="flex relative items-center h-full -mt-1 w-full sm:w-auto"
				>
					<div
						class="flex flex-row items-center cursor-pointer h-full py-1.5 pb-0 px-2 justify-center transition-all flex-1"
						@click="onMoveHome"
					>
						<div class="relative sm:flex justify-center hidden w-full">
							<div
								class="absolute w-full"
								style="
									border-bottom: 2.5px solid #6366f1;
									bottom: -17px;
								"
							></div>
							<span class="">Home</span>
						</div>
					</div>
					<div
						class="flex flex-row items-center cursor-pointer h-full py-1.5 pb-0 px-2 justify-center transition-all flex-1"
						@click="onCreateDesign"
					>
						<div class="relative sm:flex justify-center hidden w-full">
							<div
								class="absolute w-full"
								style="
									border-bottom: 2.5px solid #6366f1;
									bottom: -17px;
								"
							></div>
							<span class="">Design</span>
						</div>
					</div>
				</div>
				<div
					class="hidden w-32 h-full sm:flex gap-3 items-center justify-end mr-4"
				>
					<!-- <div class="relative w-[100px]">
						<div>
							<icon
								icon="fa-solid fa-bell"
								size="lg"
								@click="Notification"
							/>
							<div>{{ Notifi }}</div>
						</div>
						<div class="w-[100px] h-[100px] bg-white absolute left-0 top-200"></div>
					</div> -->

					<Menu as="div" class="relative inline-block text-left">
						<div>
							<MenuButton
								class="relative inline-flex w-full justify-center gap-x-1.5 rounded-md px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300"
								@click="readNotification"
							>
								<icon
									icon="fa-solid fa-bell"
									size="xl"
									style="color: aliceblue"
								/>
								<div
									v-if="countNotifi_notRead > 0"
									class="text-white absolute top-0 bg-red-500 rounded-full w-[20px] h-[20px] text-xs flex justify-center items-center"
								>
									<div>{{ countNotifi_notRead }}</div>
								</div>
								<ChevronDownIcon
									class="-mr-1 h-5 w-5 text-gray-400"
									aria-hidden="true"
								/>
							</MenuButton>
						</div>

						<transition
							enter-active-class="transition ease-out duration-100"
							enter-from-class="transform opacity-0 scale-95"
							enter-to-class="transform opacity-100 scale-100"
							leave-active-class="transition ease-in duration-75"
							leave-from-class="transform opacity-100 scale-100"
							leave-to-class="transform opacity-0 scale-95"
						>
							<MenuItems
								class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none w-[300px]"
							>
								<div
									class="py-2 fit-h max-h-[82vh] min-h-[40vh] overflow-auto"
									v-if="listNotifications.length > 0"
								>
									<MenuItem
										v-slot="{ active }"
										v-for="(notification, idx) in listNotifications"
										:key="idx"
									>
										<div
											:class="[
												active
													? 'bg-gray-100 text-gray-900'
													: 'text-gray-700',
												'block px-4 py-2 text-sm',
											]"
										>
											<div class="flex gap-2">
												<span class="font-bold">{{
													notification.user_request.username
												}}</span>
												<span> {{ notification.message }}</span>
											</div>
											<div
												class="flex justify-start items-center gap-2 border bg-gray-100"
											>
												<div class="w-[60px] border-r">
													<img
														:src="notification.design.thumbnailFront"
													/>
												</div>

												<div>{{ notification.design.name }}</div>
												<div>
													like: {{ notification.design.numberLike }}
												</div>
											</div>

											
											<div
												class="mt-2 flex justify-end items-center gap-2"
												v-if="notification.type === 'share'"
											>
												<div
													class="mt-2 flex justify-end items-center gap-2"
													v-if="!notification.is_accept"
												>
													<div
														class="bg-green-600 cursor-pointer border p-1 w-[60px] rounded-xl shadow-lg text-white flex justify-center border"
														@click="clickAcceptShare(notification)"
													>
														<div class="">Accept</div>
													</div>

													<div
														class="bg-red-600 p-1 cursor-pointer border w-[50px] border rounded-xl text-white flex justify-center shadow-lg"
														@click="clickNotAcceptShare(notification)"
													>
														<div>No</div>
													</div>
												</div>

												<div
													class="mt-2 flex justify-end items-center gap-2"
													v-else
												>
													<div
														class="font-bold"
														:class="
															notification.is_accept === 'yes'
																? 'text-green-500'
																: 'text-gray-500'
														"
													>
														{{
															notification.is_accept === 'yes'
																? 'Accepted'
																: 'Not Accept'
														}}
													</div>
												</div>
											</div>
										</div>
									</MenuItem>
								</div>
								<div
									class="py-2 fit-h max-h-[82vh] min-h-[40vh] flex justify-center items-center overflow-auto"
									v-else
								>
									<div class="text-gray-400 text-lg">
										Not find Notication
									</div>
								</div>
							</MenuItems>
						</transition>
					</Menu>

					<logoUser></logoUser>
				</div>
			</div>
			<router-view @onCreatDesign="onCreateDesign"></router-view>
			<baseModal
				:showModal="showModal"
				:products="products"
				@oncloseModal="oncloseModal"
				@onDesignProduct="onDesignProduct"
			></baseModal>
		</div>
	</div>
</template>

<script>
import { createNamespacedHelpers } from 'vuex';
const authMappper = createNamespacedHelpers('auth');
const productMappper = createNamespacedHelpers('product');
const designMappper = createNamespacedHelpers('design');
import { Menu, MenuButton, MenuItem, MenuItems } from '@headlessui/vue';
import { ChevronDownIcon } from '@heroicons/vue/20/solid';
import logoUser from '@/components/logoUser/logoUser.vue';
import baseModal from '@/components/BaseModal/baseModal.vue';
import SideBar from '@/components/Sidebar/SideBar.vue';
import DesignService from '@/sevices/design.service';
const imageAssetMappper = createNamespacedHelpers('imageAsset');
import { socket } from '@/Contant/socket';
// import { io } from 'socket.io-client';
// var connectionOptions = {
// 	withCredentials: true,
// 	transports: ['websocket'],
// };
// const socket = io('http://localhost:8888', connectionOptions);

// console.log('socket,', socket);
export default {
	components: {
		baseModal,
		SideBar,
		logoUser,
		Menu,
		MenuButton,
		MenuItem,
		MenuItems,
		ChevronDownIcon,
	},
	data() {
		return {
			isPopoverOpen: false,
			showModal: false,

			// products: [],

			//giải quyết tạm
			// menuClosedPaddingLeftBody:'78px'
		};
	},
	computed: {
		...authMappper.mapState([
			'email',
			'userInfo',
			'countNotifi_notRead',
			'listNotifications',
		]),
		...productMappper.mapState(['products', 'cataloge']),
	},
	async mounted() {
		await this.getAllProducts({ status: 'accept' });
		await this.getAllImageAssets({ userId: this.userInfo.id });
		await this.getAllNotificationByUser(this.userInfo)
		socket?.emit('newUser', this.userInfo);
		socket.on('sendNotifi', async (data) => {
			if (this.userInfo.id == data) {
				await this.getAllNotificationByUser(this.userInfo);
				console.log('data socket;', data);
			}
		});
		socket.on('resNotifiShare', async (data) => {
			if (this.userInfo.id == data) {
				await this.getAllNotificationByUser(this.userInfo);
				console.log('data socket;', data);
			}
		});
	},
	methods: {
		...productMappper.mapMutations(['SET_PRODUCT_MODEL']),
		...designMappper.mapMutations(['SET_EDIT_DESIGN']),
		...productMappper.mapActions(['getAllProducts']),
		...authMappper.mapMutations(['SET_COUNT_NOT_READ_NOTIFI']),
		...authMappper.mapActions([
			'getAllNotificationByUser',
			'updatNotifi',
			'createNotificaShare',
			'updateAcceptShare',
		]),
		...designMappper.mapActions([
			'getListDesignByUser',
			'statisticalInfoByDesign',
		]),
		...imageAssetMappper.mapActions(['getAllImageAssets']),
		togglePopover() {
			this.isPopoverOpen = !this.isPopoverOpen;
		},
		openPopover() {
			this.isPopoverOpen = true;
		},
		onChangeProfie() {
			this.$router.push('/profileDetail');
			this.isPopoverOpen = !this.isPopoverOpen;
		},
		onCreateDesign() {
			this.showModal = true;
			this.getAllProducts({ status: 'accept' });
			// console.log('Create design', this.cataloge);
		},
		onDesignProduct(product) {
			this.SET_PRODUCT_MODEL(product);
			this.$router.push('/design');
			this.SET_EDIT_DESIGN('');
		},
		oncloseModal() {
			this.showModal = false;
		},
		onMoveUserInfo() {
			this.$router.push('/userInfo');
			this.isPopoverOpen = !this.isPopoverOpen;
		},
		onMoveHome() {
			this.$router.push('/');
		},

		async readNotification() {
			await this.updatNotifi(this.userInfo);
			await this.getAllNotificationByUser(this.userInfo);
		},

		async clickAcceptShare(payload) {
			/**
			 * @param {name,description,userId,productId,object:"thong so design",thumbnailFront,thumbnailBack, isPublic}
			 */

			const params = {
				name: payload.design.name,
				description: payload.design.description,
				user: this.userInfo.id,
				product: payload.design.product,
				objects: payload.design.objects,
				thumbnailFront: payload.design.thumbnailFront,
				thumbnailBack: payload.design.thumbnailBack,
				isPublic: 'private',
			};

			try {
				await DesignService.createDesignByProduct({ params });

				console.log('params:', params);

				this.$toast.success('saved success', {
					position: 'top-right',
					duration: 2000,
				});
				await this.getListDesignByUser({
					userId: this.userInfo.id,
					isPublic: 'all',
					favoriteDesign: this.userInfo.favoriteDesign,
				});

				this.$router.push(`/userInfo`);

				await this.statisticalInfoByDesign({
					idUser: this.userInfo.id,
				});

				const param = {
					design: payload.design.id,
					user_request: this.userInfo.id,
					user_recive: payload.user_request.id,
					type: 'info',
					message: ' đã chap nhan thiet ke',
				};

				await this.createNotificaShare(param);
				await this.updateAcceptShare({
					notifiId: payload.id,
					is_accept: 'yes',
				});
				this.getAllNotificationByUser(this.userInfo);
				socket.emit('responseNotifiShare', payload.user_request.id);
			} catch (error) {
				console.log(error);
			}
		},
		async clickNotAcceptShare(payload) {
			console.log('payload:', payload);
			const param = {
				design: payload.design.id,
				user_request: this.userInfo.id,
				user_recive: payload.user_request.id,
				type: 'info',
				message: 'da khong nhan thiet ke  ',
			};

			await this.createNotificaShare(param);
			await this.updateAcceptShare({
				notifiId: payload.id,
				is_accept: 'no',
			});
			this.getAllNotificationByUser(this.userInfo);
			socket.emit('responseNotifiShare', payload.user_request.id);
		},
	},
};
</script>
<style>
/* .navbar-homePage {
	padding: 10px 260px;
} */
</style>
